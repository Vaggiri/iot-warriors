<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>IoT Sensor Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
  <link rel="stylesheet" href="style.css">
  
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
  
  <style>
    .gauge-track {
        fill: none;
        stroke: #374151; /* gray-700 */
        stroke-width: 12;
    }
    .gauge-fill {
        fill: none;
        stroke-width: 12;
        stroke-linecap: round;
        transform-origin: 50% 50%;
        transform: rotate(-90deg);
        transition: stroke-dashoffset 0.5s ease-in-out, stroke 0.5s ease-in-out;
    }
    .gauge-value {
        font-size: 2.25rem;
        font-weight: 700;
        fill: var(--color-text-primary);
    }
    .gauge-unit {
        font-size: 1.25rem;
        font-weight: 500;
        fill: var(--color-text-secondary);
    }
  </style>

</head>
<body class="min-h-screen flex flex-col">
  
  <header class="bg-header z-10">
    <div class="container mx-auto px-4 py-6">
      <div class="flex flex-col md:flex-row justify-between items-center">
        <div>
          <h1 class="text-2xl md:text-3xl font-bold text-header-text"><i class="fas fa-chart-line mr-2"></i> Smart City IoT Dashboard</h1>
          <p class="text-header-subtext mt-1">Real-time environmental monitoring</p>
        </div>
        <div class="mt-4 md:mt-0 flex items-center space-x-4">
          <div class="relative">
            <button id="alert-bell-btn" class="bg-card text-text-primary text-xl p-2 rounded-full hover:bg-card-header focus:outline-none relative">
              <i class="fas fa-bell"></i>
              <span id="alert-count-badge" class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-red-100 bg-red-600 rounded-full hidden">0</span>
            </button>
          </div>
          <div class="bg-header-accent px-3 py-1 rounded-full text-sm flex items-center"><span class="w-2 h-2 bg-green-400 rounded-full mr-2"></span><span class="text-header-text">Live Data</span></div>
          <div class="text-header-subtext text-sm">Last updated: <span id="lastUpdated">--</span></div>
          <!-- [NEW] Logout button added here -->
          <button id="logout-btn" class="bg-card text-text-primary text-xl p-2 rounded-full hover:bg-card-header focus:outline-none" title="Logout">
              <i class="fas fa-sign-out-alt"></i>
          </button>
          <button id="theme-switcher-btn" class="bg-card text-text-primary text-xl p-2 rounded-full hover:bg-card-header focus:outline-none"><i class="fas fa-moon"></i></button>
        </div>
      </div>
    </div>
  </header>
  
  <main class="flex-grow container mx-auto px-4 py-8 z-10">
    <div class="mb-6 border-b border-border">
	<nav class="flex space-x-4" aria-label="Tabs">
	<button id="tab-gauge" class="tab-button tab-active shadow-sm"><i class="fas fa-tachometer-alt mr-2"></i>Gauge</button>
	<button id="tab-analytics" class="tab-button shadow-sm"><i class="fas fa-chart-bar mr-2"></i>Analytical Data</button>
	<a href="./forecast.html" class="tab-button shadow-sm"><i class="fas fa-brain mr-2"></i>Forecasted Data</a>
	</nav></div>

    <div class="bg-card rounded-xl shadow-md p-6 mb-8">
      <h2 class="text-xl font-bold text-text-primary mb-3">System Status & Suggestions</h2>
      <div id="status-panel" class="flex items-center p-4 rounded-lg transition-all duration-500 bg-opacity-20">
          <div id="status-icon" class="text-2xl mr-4"><i class="fas fa-spinner fa-spin"></i></div>
          <div>
              <p id="status-text" class="font-semibold text-text-primary">Initializing and fetching live data...</p>
              <p id="status-suggestion" class="text-sm text-text-secondary">Please wait.</p>
          </div>
      </div>
    </div>

    <div id="tab-content-gauge">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        
        <div class="bg-card rounded-xl shadow-md overflow-hidden" data-gauge-id="temperature">
            <div class="card-header px-6 py-4 bg-card-header flex items-center">
                <i class="fas fa-thermometer-half text-red-500 mr-3 fa-lg"></i>
                <h2 class="text-lg font-semibold text-text-primary">Temperature</h2>
            </div>
            <div class="flex flex-col items-center justify-center p-6 h-80">
                <div class="w-full h-60">
                    <svg viewBox="0 0 120 120" class="w-full h-full">
                        <circle cx="60" cy="60" r="50" class="gauge-track"/>
                        <circle cx="60" cy="60" r="50" class="gauge-fill" data-max="100" />
                        <text x="60" y="68" text-anchor="middle" class="gauge-value" data-role="value">--</text>
                        <text x="60" y="90" text-anchor="middle" class="gauge-unit" data-role="unit">°C</text>
                    </svg>
                </div>
            </div>
        </div>

        <div class="bg-card rounded-xl shadow-md overflow-hidden" data-gauge-id="humidity">
            <div class="card-header px-6 py-4 bg-card-header flex items-center">
                <i class="fas fa-tint text-blue-500 mr-3 fa-lg"></i>
                <h2 class="text-lg font-semibold text-text-primary">Humidity</h2>
            </div>
            <div class="flex flex-col items-center justify-center p-6 h-80">
                <div class="w-full h-60">
                    <svg viewBox="0 0 120 120" class="w-full h-full">
                        <defs>
                            <linearGradient id="humidityGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" stop-color="#2563eb" />
                                <stop offset="50%" stop-color="#22c55e" />
                                <stop offset="100%" stop-color="#eab308" />
                            </linearGradient>
                        </defs>
                        <circle cx="60" cy="60" r="50" class="gauge-track"/>
                        <circle cx="60" cy="60" r="50" class="gauge-fill" data-max="100" stroke="url(#humidityGradient)"/>
                        <text x="60" y="68" text-anchor="middle" class="gauge-value" data-role="value">--</text>
                        <text x="60" y="90" text-anchor="middle" class="gauge-unit" data-role="unit">%</text>
                    </svg>
                </div>
            </div>
        </div>

        <div class="bg-card rounded-xl shadow-md overflow-hidden" data-gauge-id="carbon">
            <div class="card-header px-6 py-4 bg-card-header flex items-center">
                <i class="fas fa-wind text-slate-500 mr-3 fa-lg"></i>
                <h2 class="text-lg font-semibold text-text-primary">CO₂ Level</h2>
            </div>
             <div class="flex flex-col items-center justify-center p-6 h-80">
                <div class="w-full h-60">
                    <svg viewBox="0 0 120 120" class="w-full h-full">
                        <circle cx="60" cy="60" r="50" class="gauge-track"/>
                        <circle cx="60" cy="60" r="50" class="gauge-fill" data-max="800" />
                        <text x="60" y="68" text-anchor="middle" class="gauge-value" data-role="value">--</text>
                        <text x="60" y="90" text-anchor="middle" class="gauge-unit" data-role="unit">ppm</text>
                    </svg>
                </div>
            </div>
        </div>
      </div>
    </div>
    
    <div id="tab-content-analytics" class="hidden">
      <div class="bg-card rounded-xl shadow-md p-6">
        <h2 class="text-xl font-bold text-text-primary mb-4">Historical Data Analysis</h2>
        <div class="flex flex-wrap gap-4 mb-4"><select id="chart-time-filter" class="filter-select"><option value="all">All Time</option><option value="24h">Last 24 Hours</option><option value="7d">Last 7 Days</option></select><select id="chart-data-filter" class="filter-select"><option value="carbon">Carbon (ppm)</option><option value="temperature">Temperature (°C)</option><option value="humidity">Humidity (%)</option></select></div>
        <div class="h-80">
          <canvas id="analytics-chart"></canvas>
        </div>
      </div>
    </div>
    
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 my-8">
      <div class="bg-card rounded-xl shadow-md overflow-hidden"><div class="card-header px-6 py-4 bg-card-header"><h2 class="text-lg font-semibold text-text-primary"><i class="fas fa-map-marker-alt text-red-500 mr-2"></i> Sensor Location</h2></div>
        <div class="p-6">
            <div class="text-sm text-text-secondary">Coordinates</div>
            <div id="sensorLocationVal" class="font-medium text-text-primary">Loading...</div>
            <div class="text-sm text-text-secondary mt-2">Address</div>
            <div id="sensorLocationName" class="font-medium text-text-primary">Loading...</div>
        </div>
      </div>
      
      <div class="bg-card rounded-xl shadow-md overflow-hidden">
        <div class="card-header px-6 py-4 bg-card-header"><h2 class="text-lg font-semibold text-text-primary"><i class="fas fa-lightbulb text-yellow-400 mr-2"></i> Activity Suggestions</h2></div>
        <div id="activity-suggestion-panel" class="p-6">
            <div class="mb-3">
                <p class="text-sm text-text-secondary">Suggestions for your location:</p>
                <p id="user-location-text" class="font-semibold text-text-primary">Getting your location...</p>
            </div>
            <div class="flex items-center border-t border-border pt-3">
                <div id="activity-icon" class="text-4xl mr-4 text-gray-500"><i class="fas fa-question-circle"></i></div>
                <div>
                    <p id="activity-title" class="font-bold text-text-primary">Analyzing data...</p>
                    <p id="activity-description" class="text-sm text-text-secondary">Please wait for the latest readings.</p>
                </div>
            </div>
        </div>
      </div>
      
      <div class="bg-card rounded-xl shadow-md overflow-hidden">
        <div class="card-header px-6 py-4 bg-card-header flex justify-between items-center">
          <h2 class="text-lg font-semibold text-text-primary"><i class="fas fa-map text-green-600 mr-2"></i> Sensor Map</h2>
        </div>
        <div class="p-4 relative">
          <div id="map" class="rounded-lg overflow-hidden h-64"></div>
          <div id="map-legend" class="absolute bottom-6 right-6 bg-card p-2 rounded-lg shadow-xl hidden text-text-primary w-48"></div>
        </div>
      </div>
    </div>
  </main>

  <div id="toast-container" class="fixed top-5 right-5 z-50 space-y-3"></div>

  <footer class="bg-card border-t border-border py-4 z-10"><div class="container mx-auto px-4"><div class="text-center text-text-secondary text-sm">&copy; 2025 Smart City IoT Platform. All rights reserved.</div></div></footer>

  <div id="alert-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-card rounded-lg shadow-xl p-6 w-full max-w-md m-4">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-xl font-bold text-text-primary"><i class="fas fa-bell mr-2"></i> Recent Alerts</h3>
        <button id="close-alert-modal-btn" class="text-text-secondary hover:text-text-primary text-2xl">&times;</button>
      </div>
      <div id="alerts-list" class="space-y-4 max-h-80 overflow-y-auto pr-2">
        <p id="no-alerts-message" class="text-text-secondary text-center">No recent alerts.</p>
      </div>
      <div class="mt-6 text-right">
        <button id="clear-all-alerts-btn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 transition-colors duration-300 text-sm">Clear All</button>
      </div>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
        // --- GLOBAL VARIABLES & DOM Elements ---
        let analyticsChart = null, historicalData = [], map, sensorMarker, userMarker;
        const userDetails = JSON.parse(localStorage.getItem('userDetails'));
        let activeAlerts = [], unreadAlertCount = 0;
        const alertBellBtn = document.getElementById('alert-bell-btn'), alertCountBadge = document.getElementById('alert-count-badge'), alertModal = document.getElementById('alert-modal'), closeAlertModalBtn = document.getElementById('close-alert-modal-btn'), alertsList = document.getElementById('alerts-list'), noAlertsMessage = document.getElementById('no-alerts-message'), clearAllAlertsBtn = document.getElementById('clear-all-alerts-btn'), mapLegend = document.getElementById('map-legend'), themeSwitcherBtn = document.getElementById('theme-switcher-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const tabs = { gauge: { btn: document.getElementById('tab-gauge'), content: document.getElementById('tab-content-gauge') }, analytics: { btn: document.getElementById('tab-analytics'), content: document.getElementById('tab-content-analytics') } };
        const gaugeElements = { temperature: document.querySelector('[data-gauge-id="temperature"]'), humidity: document.querySelector('[data-gauge-id="humidity"]'), carbon: document.querySelector('[data-gauge-id="carbon"]') };

        // --- THEME & TABS ---
        themeSwitcherBtn.addEventListener('click', (event) => { const currentTheme = document.body.getAttribute('data-theme') || 'light'; setTheme(currentTheme === 'light' ? 'dark' : 'light', event); });
        function setTheme(themeId, event) { if (event && document.startViewTransition) { const x = event.clientX, y = event.clientY; document.documentElement.style.setProperty('--ripple-x', x + 'px'); document.documentElement.style.setProperty('--ripple-y', y + 'px'); document.startViewTransition(() => { document.body.setAttribute('data-theme', themeId); }); } else { document.body.setAttribute('data-theme', themeId); } localStorage.setItem('theme', themeId); themeSwitcherBtn.innerHTML = themeId === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>'; if (analyticsChart) { renderAnalyticsChart(); } }
        Object.keys(tabs).forEach(key => { tabs[key].btn.addEventListener('click', () => { Object.values(tabs).forEach(t => { t.btn.classList.remove('tab-active'); t.content.classList.add('hidden'); }); tabs[key].btn.classList.add('tab-active'); tabs[key].content.classList.remove('hidden'); if (key === 'analytics') { renderAnalyticsChart(); } }); });

        // --- [NEW] LOGOUT FUNCTIONALITY ---
        logoutBtn.addEventListener('click', () => {
            localStorage.removeItem('userDetails'); // Clear user session
            window.location.href = './index.html'; // Redirect to login
        });

        // --- GEOCODING ---
        async function getAddressFromCoords(lat, lng) { 
            try { 
                const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`, {
                    headers: { 'User-Agent': 'IoT Dashboard Application' }
                }); 
                if (!response.ok) return "Address lookup failed."; 
                const data = await response.json(); 
                return data.display_name || "Unknown Location"; 
            } catch (error) { 
                console.error("Geocoding error:", error); 
                return "Address not found."; 
            } 
        }

        // --- Get User Location and add red marker ---
        async function personalizeSuggestions() {
            if (!navigator.geolocation) {
                document.getElementById('user-location-text').textContent = "Geolocation not supported.";
                return;
            }
            navigator.geolocation.getCurrentPosition(async (position) => {
                const { latitude, longitude } = position.coords;
                const address = await getAddressFromCoords(latitude, longitude);
                document.getElementById('user-location-text').textContent = address;
                const redIcon = new L.Icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] });
                if (userMarker) {
                    userMarker.setLatLng([latitude, longitude]);
                } else {
                    userMarker = L.marker([latitude, longitude], { icon: redIcon }).addTo(map);
                }
                userMarker.bindPopup("Your Location").openPopup();
                map.setView([latitude, longitude], 13);
            }, () => {
                document.getElementById('user-location-text').textContent = "Could not get location. Showing general suggestions.";
            });
        }

        // --- LIVE FIREBASE DATA FETCHING ---
        async function fetchData() {
            try {
                const response = await fetch('https://gas-value-33f5a-default-rtdb.firebaseio.com/SensorData.json');
                if (!response.ok) throw new Error(`Network Error: ${response.statusText}`);
                const liveData = await response.json();
                if (liveData && liveData.location) {
                    const [lat, lng] = liveData.location.split(',').map(Number);
                    const address = await getAddressFromCoords(lat, lng);
                    const formattedData = { temperature: liveData.temperature, humidity: liveData.humidity, carbon: liveData.carbon, latitude: lat, longitude: lng, locationName: address, timestamp: liveData.timestamp };
                    updateDashboard(formattedData);
                    checkThresholds(formattedData);
                    historicalData.push(formattedData);
                    if (historicalData.length > 30) { 
                        historicalData.shift(); 
                    }
                    localStorage.setItem('historicalData', JSON.stringify(historicalData));
                    if (!tabs.analytics.content.classList.contains('hidden')) { renderAnalyticsChart(); }
                    updateAllHeatmaps();
                }
            } catch (error) { console.error("Failed to fetch live data:", error); }
        }

        // --- DATA INSIGHTS ---
        function updateStatusPanel(data) {
            const statusPanel = document.getElementById('status-panel'), statusIcon = document.getElementById('status-icon'), statusText = document.getElementById('status-text'), statusSuggestion = document.getElementById('status-suggestion');
            if (data.carbon > THRESHOLDS.co2) { statusPanel.className = 'flex items-center p-4 rounded-lg transition-all duration-500 bg-red-500 bg-opacity-20'; statusIcon.innerHTML = '<i class="fas fa-wind text-red-500"></i>'; statusText.textContent = 'High CO₂ Levels Detected!'; statusSuggestion.textContent = 'Suggestion: Ensure proper ventilation.'; }
            else if (data.temperature > THRESHOLDS.temp) { statusPanel.className = 'flex items-center p-4 rounded-lg transition-all duration-500 bg-red-500 bg-opacity-20'; statusIcon.innerHTML = '<i class="fas fa-temperature-high text-red-500"></i>'; statusText.textContent = 'High Temperature Alert!'; statusSuggestion.textContent = 'Suggestion: Check for potential fire hazards.'; }
            else { statusPanel.className = 'flex items-center p-4 rounded-lg transition-all duration-500 bg-green-500 bg-opacity-20'; statusIcon.innerHTML = '<i class="fas fa-check-circle text-green-500"></i>'; statusText.textContent = 'All Systems Normal.'; statusSuggestion.textContent = 'Environmental conditions are stable.'; }
        }
        function updateActivitySuggestions(data) {
            const iconEl = document.getElementById('activity-icon'), titleEl = document.getElementById('activity-title'), descriptionEl = document.getElementById('activity-description');
            const { temperature, humidity, carbon } = data;
            if (carbon > 600 || temperature > 38) { iconEl.innerHTML = '<i class="fas fa-house-user text-blue-500"></i>'; titleEl.textContent = "Best to Stay Indoors"; descriptionEl.textContent = `High CO₂ or extreme heat makes outdoor activities unsafe.`; }
            else if (temperature > 20 && temperature < 30 && humidity < 70 && carbon < 450) { iconEl.innerHTML = '<i class="fas fa-campground text-green-500"></i>'; titleEl.textContent = "Perfect for a Picnic or Camping!"; descriptionEl.textContent = "Ideal weather and excellent air quality for jogging or picnics."; }
            else { iconEl.innerHTML = '<i class="fas fa-city text-gray-500"></i>'; titleEl.textContent = "Conditions are Average"; descriptionEl.textContent = "Most outdoor activities are suitable with standard precautions."; }
        }

        // --- DASHBOARD UPDATE ---
        function updateDashboard(data) {
            document.getElementById("lastUpdated").textContent = new Date(data.timestamp).toLocaleTimeString('en-US');
            document.getElementById("sensorLocationVal").textContent = `${data.latitude.toFixed(4)}, ${data.longitude.toFixed(4)}`;
            document.getElementById("sensorLocationName").textContent = data.locationName;
            sensorMarker.setLatLng([data.latitude, data.longitude]);
            updateGauge(gaugeElements.temperature, data.temperature);
            updateGauge(gaugeElements.humidity, data.humidity);
            updateGauge(gaugeElements.carbon, data.carbon);
            updateStatusPanel(data);
            updateActivitySuggestions(data);
        }

        // --- SVG GAUGE UPDATE FUNCTION ---
        function updateGauge(gaugeElement, value) {
            if (!gaugeElement) return;
            const fill = gaugeElement.querySelector('.gauge-fill'), valueText = gaugeElement.querySelector('[data-role="value"]');
            const gaugeId = gaugeElement.dataset.gaugeId, max = parseFloat(fill.dataset.max);
            const targetValue = Math.min(value, max);
            const circumference = 2 * Math.PI * fill.r.baseVal.value, offset = circumference * (1 - (targetValue / max));
            fill.style.strokeDasharray = circumference; fill.style.strokeDashoffset = offset;
            const startValue = parseInt(valueText.textContent) || 0, roundedTarget = Math.round(targetValue);
            if (startValue === roundedTarget) return;
            if (valueText.animationInterval) clearInterval(valueText.animationInterval);
            let currentValue = startValue;
            valueText.animationInterval = setInterval(() => {
                const increment = (roundedTarget - startValue) / 30;
                currentValue += increment;
                if ((increment > 0 && currentValue >= roundedTarget) || (increment < 0 && currentValue <= roundedTarget)) { currentValue = roundedTarget; clearInterval(valueText.animationInterval); }
                valueText.textContent = Math.round(currentValue);
            }, 16);
            if (gaugeId === 'temperature') fill.style.stroke = getTemperatureColor(targetValue);
            else if (gaugeId === 'carbon') fill.style.stroke = getCO2Color(targetValue);
        }
        
        // --- ALERTING SYSTEM ---
        const THRESHOLDS = { temp: 45, co2: 500, humidity: 80 }; let lastAlertTimes = { temp: 0, co2: 0, humidity: 0 }; const ALERT_COOLDOWN = 300000;
        function checkThresholds(data) { const now = Date.now(); if (data.temperature > THRESHOLDS.temp && (now - lastAlertTimes.temp > ALERT_COOLDOWN)) { sendAlert('Temperature', `${data.temperature}°C`, 'error'); lastAlertTimes.temp = now; } if (data.carbon > THRESHOLDS.co2 && (now - lastAlertTimes.co2 > ALERT_COOLDOWN)) { sendAlert('CO2 Level', `${data.carbon} ppm`, 'error'); lastAlertTimes.co2 = now; } }
        function sendAlert(metric, value, type) { const location = document.getElementById('sensorLocationName').textContent; const message = `High ${metric} detected: ${value} at ${location}.`; const timestamp = new Date().toLocaleString(); showToast(message, type); activeAlerts.unshift({ metric, value, type, location, timestamp }); unreadAlertCount++; updateAlertBadge(); }
        function showToast(message, type = 'error') { const c = document.getElementById('toast-container'), t = document.createElement('div'); t.className = `toast toast-${type}`; t.innerHTML = `<strong><i class="fas fa-exclamation-triangle mr-2"></i>Alert!</strong><p class="text-sm">${message}</p>`; c.appendChild(t); setTimeout(() => t.classList.add('show'), 100); setTimeout(() => { t.classList.remove('show'); setTimeout(() => t.remove(), 300); }, 5000); }
        alertBellBtn.addEventListener('click', () => { renderAlertsInModal(); alertModal.classList.remove('hidden'); unreadAlertCount = 0; updateAlertBadge(); });
        closeAlertModalBtn.addEventListener('click', () => { alertModal.classList.add('hidden'); });
        clearAllAlertsBtn.addEventListener('click', () => { activeAlerts = []; renderAlertsInModal(); unreadAlertCount = 0; updateAlertBadge(); });
        function updateAlertBadge() { if (unreadAlertCount > 0) { alertCountBadge.textContent = unreadAlertCount; alertCountBadge.classList.remove('hidden'); } else { alertCountBadge.classList.add('hidden'); } }
        function renderAlertsInModal() { alertsList.innerHTML = ''; if (activeAlerts.length === 0) { noAlertsMessage.classList.remove('hidden'); alertsList.appendChild(noAlertsMessage); } else { noAlertsMessage.classList.add('hidden'); activeAlerts.forEach(a => { const d = document.createElement('div'); d.className = `bg-card-header p-3 rounded-md border-l-4 ${a.type === 'error' ? 'border-red-500' : 'border-yellow-500'}`; d.innerHTML = `<p class="font-semibold text-text-primary">${a.metric}: ${a.value}</p><p class="text-xs text-text-secondary">${a.location}</p><p class="text-xs text-text-secondary">${a.timestamp}</p>`; alertsList.appendChild(d); }); } }
        
        // --- ADVANCED COLOR LOGIC ---
        function interpolateColor(c1, c2, f) { const r1 = parseInt(c1.substring(1, 3), 16), g1 = parseInt(c1.substring(3, 5), 16), b1 = parseInt(c1.substring(5, 7), 16); const r2 = parseInt(c2.substring(1, 3), 16), g2 = parseInt(c2.substring(3, 5), 16), b2 = parseInt(c2.substring(5, 7), 16); const r = Math.round(r1 + f * (r2 - r1)), g = Math.round(g1 + f * (g2 - g1)), b = Math.round(b1 + f * (b2 - b1)); return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`; }
        function getTemperatureColor(value) { const b = "#3b82f6", g = "#22c55e", y = "#eab308", lr = "#f87171", mr = "#ef4444", dr = "#b91c1c"; if (value <= 25) return interpolateColor(b, g, value / 25); if (value <= 40) return interpolateColor(g, y, (value - 25) / 15); if (value <= 50) return interpolateColor(y, lr, (value - 40) / 10); if (value <= 70) return interpolateColor(lr, mr, (value - 50) / 20); return interpolateColor(mr, dr, (value - 70) / 30); }
        function getCO2Color(value) { const g = "#22c55e", y = "#eab308", lr = "#f87171", mr = "#ef4444", dr = "#b91c1c"; if (value < 350) return g; if (value <= 450) return interpolateColor(g, y, (value - 350) / 100); if (value <= 500) return interpolateColor(y, lr, (value - 450) / 50); if (value <= 700) return interpolateColor(lr, mr, (value - 500) / 200); return interpolateColor(mr, dr, (value - 700) / 100); }

        // --- MAP & CHART LOGIC ---
        let tempHeatLayer, humidityHeatLayer, co2HeatLayer, layerControl;
        function getGradient(type) { if (type === 'temperature') return { 0.4: '#0000ff', 0.8: '#ffff00', 1.0: '#ff0000' }; if (type === 'humidity') return { 0.4: '#ffff00', 0.8: '#0000ff', 1.0: '#00008b' }; if (type === 'co2') return { 0.4: '#008000', 0.8: '#ffff00', 1.0: '#ff0000' }; return {}; }
        function updateAllHeatmaps() { if (historicalData.length > 0) { tempHeatLayer.setLatLngs(historicalData.map(d => [d.latitude, d.longitude, d.temperature])); humidityHeatLayer.setLatLngs(historicalData.map(d => [d.latitude, d.longitude, d.humidity])); co2HeatLayer.setLatLngs(historicalData.map(d => [d.latitude, d.longitude, d.carbon])); } }
        function updateLegend(type) { if (!type) { mapLegend.classList.add('hidden'); return; } let c = `<h4 class="font-bold text-xs mb-1">${type.charAt(0).toUpperCase() + type.slice(1)}</h4>`; if (type === 'temperature') c += `<div class="w-full h-3 rounded-md" style="background: linear-gradient(to right, #0000ff, #ffff00, #ff0000);"></div><div class="flex justify-between text-xs mt-1"><span>25°C</span><span>45°C</span></div>`; else if (type === 'humidity') c += `<div class="w-full h-3 rounded-md" style="background: linear-gradient(to right, #ffff00, #0000ff, #00008b);"></div><div class="flex justify-between text-xs mt-1"><span>30%</span><span>80%</span></div>`; else if (type === 'co2') c += `<div class="w-full h-3 rounded-md" style="background: linear-gradient(to right, #008000, #ffff00, #ff0000);"></div><div class="flex justify-between text-xs mt-1"><span>200</span><span>500+</span></div>`; mapLegend.innerHTML = c; mapLegend.classList.remove('hidden'); }
        const chartCanvas = document.getElementById('analytics-chart'), chartTimeFilter = document.getElementById('chart-time-filter'), chartDataFilter = document.getElementById('chart-data-filter');
        chartTimeFilter.addEventListener('change', renderAnalyticsChart); chartDataFilter.addEventListener('change', renderAnalyticsChart);
        
        // --- RENDER ANALYTICS CHART ---
        function renderAnalyticsChart() {
            if (historicalData.length === 0) return;
            if (analyticsChart) { analyticsChart.destroy(); }
            const timeFilter = chartTimeFilter.value, selectedDataKey = chartDataFilter.value;
            let chartLabels = [], chartData = [], timeUnit = 'hour';
            const now = new Date();
            if (timeFilter === '24h') {
                const twentyFourHoursAgo = new Date(now.getTime() - 24 * 3600 * 1000);
                const relevantData = historicalData.filter(d => new Date(d.timestamp) > twentyFourHoursAgo);
                const slots = {};
                for (let i = 0; i < 48; i++) { slots[new Date(twentyFourHoursAgo.getTime() + i * 30 * 60 * 1000).toISOString()] = []; }
                relevantData.forEach(d => {
                    const slotIndex = Math.floor((new Date(d.timestamp) - twentyFourHoursAgo) / (30 * 60 * 1000));
                    if (slotIndex >= 0 && slotIndex < 48) { slots[new Date(twentyFourHoursAgo.getTime() + slotIndex * 30 * 60 * 1000).toISOString()].push(d[selectedDataKey]); }
                });
                for (const time in slots) { chartLabels.push(new Date(time)); const values = slots[time]; chartData.push(values.length > 0 ? values.reduce((a, b) => a + b, 0) / values.length : null); }
            } else if (timeFilter === '7d') {
                timeUnit = 'day';
                const sevenDaysAgo = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 6);
                const relevantData = historicalData.filter(d => new Date(d.timestamp) >= sevenDaysAgo);
                const days = {};
                for(let i=0; i<7; i++){ const day = new Date(sevenDaysAgo.getFullYear(), sevenDaysAgo.getMonth(), sevenDaysAgo.getDate() + i); days[day.toISOString().split('T')[0]] = []; }
                relevantData.forEach(d => { const dayKey = new Date(d.timestamp).toISOString().split('T')[0]; if(days[dayKey]){ days[dayKey].push(d[selectedDataKey]); } });
                for (const day in days) { chartLabels.push(new Date(day)); const values = days[day]; chartData.push(values.length > 0 ? values.reduce((a, b) => a + b, 0) / values.length : null); }
            } else { chartLabels = historicalData.map(d => new Date(d.timestamp)); chartData = historicalData.map(d => d[selectedDataKey]); }
            const theme = document.body.getAttribute('data-theme') || 'light';
            const gridColor = theme === 'dark' ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)', fontColor = theme === 'dark' ? '#f8fafc' : '#1f2937';
            const ctx = chartCanvas.getContext('2d'), gradient = ctx.createLinearGradient(0, 0, 0, 320);
            const primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--color-primary').trim();
            gradient.addColorStop(0, `${primaryColor}99`); gradient.addColorStop(1, `${primaryColor}11`);
            analyticsChart = new Chart(chartCanvas, { 
                type: 'line', 
                data: { labels: chartLabels, datasets: [{ label: chartDataFilter.options[chartDataFilter.selectedIndex].text, data: chartData, backgroundColor: gradient, borderColor: primaryColor, borderWidth: 2, tension: 0.4, fill: true, pointRadius: 2, pointBackgroundColor: primaryColor }] }, 
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'time', time: { unit: timeUnit, tooltipFormat: 'MMM d, h:mm a' }, grid: { display: true, color: gridColor }, ticks: { color: fontColor, maxRotation: 0, autoSkip: true, maxTicksLimit: 10 } }, y: { beginAtZero: false, grid: { color: gridColor }, ticks: { color: fontColor } } }, plugins: { legend: { labels: { color: fontColor } }, tooltip: { intersect: false, mode: 'index', } }, interaction: { mode: 'nearest', axis: 'x', intersect: false } } 
            }); 
        }
        
        // --- INITIALIZATION ---
        function initializeDashboard() {
            const savedData = localStorage.getItem('historicalData');
            historicalData = savedData ? JSON.parse(savedData) : [];
            setTheme(localStorage.getItem('theme') || 'light');
            personalizeSuggestions();
            const initialCoords = [10.9085, 76.9098];
            map = L.map('map').setView(initialCoords, 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);
            const blueIcon = new L.Icon({ iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png', shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png', iconSize: [25, 41], iconAnchor: [12, 41], popupAnchor: [1, -34], shadowSize: [41, 41] });
            sensorMarker = L.marker(initialCoords, { icon: blueIcon }).addTo(map).bindPopup("Sensor Location");
            const heatOptions = { radius: 25, blur: 15, maxZoom: 18, minOpacity: 0.6 };
            tempHeatLayer = L.heatLayer([], { ...heatOptions, gradient: getGradient('temperature'), max: 50 });
            humidityHeatLayer = L.heatLayer([], { ...heatOptions, gradient: getGradient('humidity'), max: 100 });
            co2HeatLayer = L.heatLayer([], { ...heatOptions, gradient: getGradient('co2'), max: 600 }).addTo(map);
            const overlayMaps = { "<i class='fas fa-thermometer-half mr-2 text-red-500'></i> Temperature": tempHeatLayer, "<i class='fas fa-tint mr-2 text-blue-500'></i> Humidity": humidityHeatLayer, "<i class='fas fa-wind mr-2 text-gray-500'></i> CO₂": co2HeatLayer };
            layerControl = L.control.layers(null, overlayMaps, { position: 'topright', collapsed: false }).addTo(map);
            let visibleLayer = 'co2';
            updateLegend(visibleLayer);
            map.on('overlayadd', function(e) { if (e.name.includes('Temperature')) visibleLayer = 'temperature'; else if (e.name.includes('Humidity')) visibleLayer = 'humidity'; else if (e.name.includes('CO₂')) visibleLayer = 'co2'; updateLegend(visibleLayer); });
            map.on('overlayremove', function(e) { updateLegend(null); });
            if (historicalData.length > 0) {
                updateAllHeatmaps();
                updateDashboard(historicalData[historicalData.length - 1]);
            }
            fetchData();
            setInterval(fetchData, 5000);
        }

        initializeDashboard();
    });
  </script>
</body>
</html>

